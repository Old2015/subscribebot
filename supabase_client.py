import psycopg2                                  # –¥—Ä–∞–π–≤–µ—Ä PostgreSQL
import logging                                   # –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

from datetime import datetime, timedelta         # —Ä–∞–±–æ—Ç–∞ —Å –¥–∞—Ç–∞–º–∏
from config import DB_USER, DB_PASSWORD, DB_HOST, DB_PORT, DB_NAME
from typing import Optional, Tuple
log = logging.getLogger(__name__)                # –ª–æ–≥–≥–µ—Ä –º–æ–¥—É–ª—è


# -----------------------------------------------------------------
# Join-request —Å—Å—ã–ª–∫–∏ —Ö—Ä–∞–Ω–∏–º –ø—Ä—è–º–æ –≤ users (invite_link + invite_expires_at)
# -----------------------------------------------------------------




# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def _get_connection():
    return psycopg2.connect(
        user=DB_USER,
        password=DB_PASSWORD,
        host=DB_HOST,
        port=DB_PORT,
        database=DB_NAME,
    )

# -----------------------------------------------------------------
#  join-request-—Å—Å—ã–ª–∫–∏ —Ö—Ä–∞–Ω–∏–º –ø—Ä—è–º–æ –≤ users (invite_link + invite_expires_at)
# -----------------------------------------------------------------

def get_invite(user_id: int) -> Tuple[Optional[str], Optional[datetime]]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (link, expires_at) –∏–ª–∏ (None, None), –µ—Å–ª–∏ —Å—Å—ã–ª–∫–∏ –Ω–µ—Ç.
    """
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            SELECT invite_link, invite_expires_at
              FROM users
             WHERE id = %s
            """,
            (user_id,),
        )
        row = cur.fetchone()
        return (row[0], row[1]) if row else (None, None)


def upsert_invite(user_id: int, link: str, exp: datetime) -> None:
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç / –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É (invite_link, invite_expires_at).
    """
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            UPDATE users
               SET invite_link        = %s,
                   invite_expires_at  = %s
             WHERE id = %s
            """,
            (link, exp, user_id),
        )
        conn.commit()


def clear_invite(user_id: int) -> None:
    """
    –û–±–Ω—É–ª—è–µ–º —Å—Å—ã–ª–∫—É –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—Ö–æ–¥–∞.
    """
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            UPDATE users
               SET invite_link       = NULL,
                   invite_expires_at = NULL
             WHERE id = %s
            """,
            (user_id,),
        )
        conn.commit()


def check_db_structure():
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü—ã 'users' –∏ 'payments' –¥–æ—Å—Ç—É–ø–Ω—ã.
    –ï—Å–ª–∏ –∏—Ö –Ω–µ—Ç –∏–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–±–ª–µ–º—ã ‚Äî –ª–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É.
    """
    tables = ["users", "payments"]
    for t in tables:
        try:
            with _get_connection() as conn:
                with conn.cursor() as cur:
                    cur.execute(f"SELECT 1 FROM {t} LIMIT 1")
            log.info(f"–¢–∞–±–ª–∏—Ü–∞ '{t}' –¥–æ—Å—Ç—É–ø–Ω–∞.")
        except psycopg2.Error as e:
            log.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–∞–±–ª–∏—Ü—ã '{t}': {e}")



def create_user_custom_trial(telegram_id: int, username: str, trial_end: datetime):
    """
    –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å trial_end = –∑–∞–¥–∞–Ω–Ω–∞—è –¥–∞—Ç–∞/–≤—Ä–µ–º—è.
    """
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO users (
                    telegram_id,
                    username,
                    trial_start,   -- üëà
                    trial_end,
                    created_at)
                VALUES (
                    %s,
                    %s,
                    NOW(),         -- trial_start = —Å–µ–π—á–∞—Å
                    %s,            -- trial_end   = –ø–∞—Ä–∞–º–µ—Ç—Ä —Ñ—É–Ω–∫—Ü–∏–∏
                    NOW())
                RETURNING *
            """, (telegram_id, username, trial_end))
            row = cur.fetchone()
            conn.commit()
            if row:
                cols = [desc[0] for desc in cur.description]
                return dict(zip(cols, row))
    return None

def get_user_by_telegram_id(telegram_id: int):
    """
    –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ 'users' –ø–æ –ø–æ–ª—é telegram_id.
    –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª–æ–≤–∞—Ä—å (–∫–æ–ª–æ–Ω–∫–∏) –∏–ª–∏ None, –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω.
    """
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("SELECT * FROM users WHERE telegram_id = %s", (telegram_id,))
            row = cur.fetchone()
            if not row:
                return None
            cols = [desc[0] for desc in cur.description]
            return dict(zip(cols, row))

def create_user_with_trial(telegram_id: int, username: str, trial_days: int):
    """
    –°–æ–∑–¥–∞—ë–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
      - telegram_id (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)
      - username
      - trial_end = NOW() + interval 'X day'
      - created_at = NOW()
    –í–æ–∑–≤—Ä–∞—â–∞–µ–º dict —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Å—Ç—Ä–æ–∫–∞ –∏–∑ –ë–î).
    """
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO users (
                    telegram_id,
                    username,
                    trial_start,      -- üëà –Ω–æ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞
                    trial_end,
                    created_at)
                VALUES (
                    %s,
                    %s,
                    NOW(),                               -- trial_start = —Å–µ–π—á–∞—Å
                    NOW() + interval '%s day',           -- trial_end  = +N –¥–Ω–µ–π
                    NOW()) 
                RETURNING *
            """, (telegram_id, username, trial_days))
            row = cur.fetchone()
            conn.commit()

            if row:
                cols = [desc[0] for desc in cur.description]
                return dict(zip(cols, row))
            return None





def set_deposit_address_and_privkey(user_id: int, address: str, privkey: str):
    """
    –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –¥–µ–ø–æ–∑–∏—Ç–Ω—ã–π –∞–¥—Ä–µ—Å, –µ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏ –≤—Ä–µ–º—è –≤—ã–¥–∞—á–∏.
    """
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute("""
            UPDATE users
               SET deposit_address     = %s,
                   deposit_privkey     = %s,
                   deposit_created_at  = NOW(),
                   energy_deposit_sun  = NULL
             WHERE id = %s
        """, (address, privkey, user_id))
        conn.commit()

def get_pending_deposits_with_privkey():
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–∫—Ç–∏–≤–Ω—ã–º –¥–µ–ø–æ–∑–∏—Ç–æ–º, –≥–¥–µ –µ—Å—Ç—å –∏ –∞–¥—Ä–µ—Å, –∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á.
    """
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute("""
            SELECT id, telegram_id, deposit_address, deposit_privkey, deposit_created_at
              FROM users
             WHERE deposit_address IS NOT NULL
               AND deposit_privkey IS NOT NULL
        """)
        rows = cur.fetchall()
        cols = [d[0] for d in cur.description]
        return [dict(zip(cols, r)) for r in rows]
    
def get_all_deposit_addresses() -> list[str]:
    with _get_connection() as c, c.cursor() as cur:
        cur.execute("SELECT deposit_address FROM users WHERE deposit_address IS NOT NULL")
        return [r[0] for r in cur.fetchall()]
    

def reset_deposit_address_and_privkey(user_id: int):
    """
    –û–±–Ω—É–ª—è–µ–º –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∞–¥—Ä–µ—Å –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è/–∏—Å—Ç–µ—á–µ–Ω–∏—è.
    """
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute("""
            UPDATE users
               SET deposit_address    = NULL,
                   deposit_privkey    = NULL,
                   deposit_created_at = NULL
             WHERE id = %s
        """, (user_id,))
        conn.commit()



# –ü—Ä–∏–º–µ—Ä—ã —Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã payments, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã:

def create_payment(user_id: int, txhash: str, amount_usdt: float, days_added: int):
    """
    –í—Å—Ç–∞–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –æ –ø–ª–∞—Ç–µ–∂–µ –≤ 'payments':
      user_id, txhash, amount_usdt, days_added, paid_at=NOW(), status='paid', created_at=NOW()
    –í–æ–∑–≤—Ä–∞—â–∞–µ–º id –ø–ª–∞—Ç—ë–∂–Ω–æ–π –∑–∞–ø–∏—Å–∏.
    """
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO payments(user_id, txhash, amount_usdt, days_added, paid_at, status, created_at)
                VALUES (%s, %s, %s, %s, NOW(), 'paid', NOW())
                RETURNING id
            """, (user_id, txhash, amount_usdt, days_added))
            row = cur.fetchone()
            conn.commit()
            if row:
                return row[0]
            return None

def get_payment_by_id(payment_id: int):
    """
    –ü—Ä–∏–º–µ—Ä: –≤–µ—Ä–Ω—É—Ç—å –∑–∞–ø–∏—Å—å –æ –ø–ª–∞—Ç–µ–∂–µ –ø–æ ID.
    """
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("SELECT * FROM payments WHERE id = %s", (payment_id,))
            row = cur.fetchone()
            if row:
                cols = [desc[0] for desc in cur.description]
                return dict(zip(cols, row))
    return None




def create_payment(user_id: int, txhash: str, amount_usdt: float, days_added: int):
    """
    –°–æ–∑–¥–∞—ë–º –∑–∞–ø–∏—Å—å –≤ payments.
    """
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                INSERT INTO payments(user_id, txhash, amount_usdt, days_added, 
                                     paid_at, created_at)
                VALUES (%s, %s, %s, %s, NOW(), NOW())
            """, (user_id, txhash, amount_usdt, days_added))
            conn.commit()


def update_deposit_address(user_id: int, address: str, priv_hex: str | None):
    """
    –û–±–Ω–æ–≤–ª—è–µ–º (–∏–ª–∏ —Å–æ–∑–¥–∞—ë–º) –∞–¥—Ä–µ—Å –¥–µ–ø–æ–∑–∏—Ç–∞.
    –ï—Å–ª–∏ priv_hex=None  ‚Äì –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –Ω–µ –º–µ–Ω—è–µ–º.
    """
    with _get_connection() as conn, conn.cursor() as cur:
        if priv_hex is None:
            cur.execute("""
                UPDATE users
                   SET deposit_address = %s,
                       deposit_created_at = NOW()
                 WHERE id = %s
            """, (address, user_id))
        else:
            cur.execute("""
                UPDATE users
                   SET deposit_address = %s,
                       deposit_privkey   = %s,
                       deposit_created_at = NOW()
                 WHERE id = %s
            """, (address, priv_hex, user_id))

def update_payment_days(user_id: int, amount_usdt: float, days_added: int) -> None:
    """
    –û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ days_added –≤ –°–ê–ú–û–ô –ü–û–°–õ–ï–î–ù–ï–ô –∑–∞–ø–∏—Å–∏ payments
    –¥–ª—è –¥–∞–Ω–Ω–æ–≥–æ user_id –∏ —Ç–æ–π –∂–µ —Å—É–º–º—ã USDT.
    """
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            WITH last_pay AS (
                SELECT id
                FROM   payments
                WHERE  user_id = %s
                  AND  amount_usdt = %s
                ORDER  BY id DESC
                LIMIT  1
            )
            UPDATE payments AS p
            SET    days_added = %s
            FROM   last_pay
            WHERE  p.id = last_pay.id
            RETURNING p.id
            """,
            (user_id, amount_usdt, days_added)
        )
        conn.commit()

def apply_subscription_extension(user_id: int, days_to_add: int):
    """
    –ü—Ä–æ–¥–ª—è–µ–º/–Ω–∞–∑–Ω–∞—á–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É. 
    –£—á–∏—Ç—ã–≤–∞–µ–º trial_end vs subscription_end:
      - –ï—Å–ª–∏ subscription_end > now => subscription_end += days_to_add
      - –ò–Ω–∞—á–µ => subscription_end = now + days_to_add
      - –ù–æ –µ—Å–ª–∏ trial_end > now => –ø–æ–¥–ø–∏—Å–∫–∞ –º–æ–∂–µ—Ç –Ω–∞—á–∞—Ç—å—Å—è –ø–æ—Å–ª–µ trial_end
    """
    now = datetime.now()
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT trial_end, subscription_start, subscription_end
                  FROM users
                 WHERE id=%s
            """, (user_id,))
            row = cur.fetchone()
            if not row:
                return
            trial_end, sub_start, sub_end = row

            # –í—ã—á–∏—Å–ª–∏–º start_point
            if trial_end and trial_end > now:
                start_point = trial_end
            else:
                # –ï—Å–ª–∏ sub_end –µ—â–µ –∞–∫—Ç–∏–≤–µ–Ω => –Ω–∞—á–∏–Ω–∞–µ–º —Å sub_end
                if sub_end and sub_end > now:
                    start_point = sub_end
                else:
                    start_point = now

            new_sub_start = start_point if sub_start is None or sub_start < start_point else sub_start
            new_sub_end = start_point + timedelta(days=days_to_add)
            # –ü–æ–¥–ø–∏—Å–∫–∞ –¥–µ–π—Å—Ç–≤—É–µ—Ç –≤–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –ø–æ –¥–∞—Ç—É new_sub_end,
            # –ø–æ—ç—Ç–æ–º—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è 23:59:59 —Ç–æ–≥–æ –∂–µ –¥–Ω—è
            new_sub_end = new_sub_end.replace(hour=23, minute=59, second=59, microsecond=0)

            cur.execute("""
                UPDATE users
                   SET subscription_start = %s,
                       subscription_end   = %s
                 WHERE id = %s
            """, (new_sub_start, new_sub_end, user_id))
            conn.commit()

def get_user_sub_info(user_id: int) -> str:
    """
    –ü—Ä–∏–º–µ—Ä: –≤–µ—Ä–Ω—ë–º —Å—Ç—Ä–æ–∫—É "–í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –¥–æ 12.06.2025 (–µ—â—ë 45 –¥–Ω–µ–π)."
    –ï—Å–ª–∏ –Ω–µ—Ç sub_end, "–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∞" 
    """
    now = datetime.now()
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute("""
                SELECT subscription_start, subscription_end
                  FROM users
                 WHERE id=%s
            """, (user_id,))
            row = cur.fetchone()
            if not row:
                return "Subscription not found."
            sstart, send = row
            if not send:
                return "No subscription has been purchased."

            if send > now:
                dleft = (send - now).days
                return f"Your subscription is active until  {send.strftime('%d.%m.%Y')} (~{dleft} days)."
            else:
                return "–üThe subscription period has ended."

# –≤–Ω–∏–∑—É —Ñ–∞–π–ª–∞ (–ø–æ—Å–ª–µ apply_subscription_extension)

def get_subscription_(user_id: int):
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç datetime expiration (–∏–ª–∏ None),
    —á—Ç–æ–±—ã –∫—Ä–∞—Å–∏–≤–æ –ø–æ–∫–∞–∑–∞—Ç—å –¥–∏–∞–ø–∞–∑–æ–Ω –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
    """
    with _get_connection() as conn:
        with conn.cursor() as cur:
            cur.execute(
                "SELECT subscription_end FROM users WHERE id=%s",
                (user_id,)
            )
            row = cur.fetchone()
            return row[0] if row else None
        
# –î–æ–±–∞–≤—å—Ç–µ –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é
def set_subscription_period(user_id: int, start: datetime, end: datetime) -> None:
    """–û–±–Ω–æ–≤–ª—è–µ—Ç subscription_start + subscription_end."""
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            UPDATE users
               SET subscription_start = %s,
                   subscription_end   = %s
             WHERE id = %s
            """,
            (start, end, user_id)
        )
        conn.commit()



def get_all_users():
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute("SELECT * FROM users")
        rows = cur.fetchall()
        cols = [d[0] for d in cur.description]
        return [dict(zip(cols, r)) for r in rows]


def get_new_users_last_day() -> list[tuple[int, str | None]]:
    """Returns (telegram_id, username) for users created during the previous day."""
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            SELECT telegram_id, username
              FROM users
             WHERE created_at >= date_trunc('day', NOW()) - interval '1 day'
               AND created_at <  date_trunc('day', NOW())
             ORDER BY created_at
            """
        )
        return cur.fetchall()


def get_expired_users_last_day() -> list[tuple[int, str | None]]:
    """Returns users whose trial or subscription ended during the previous day."""
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            SELECT telegram_id, username
              FROM users
             WHERE (
                     trial_end >= date_trunc('day', NOW()) - interval '1 day'
                 AND trial_end <  date_trunc('day', NOW())
                  )
                OR (
                     subscription_end >= date_trunc('day', NOW()) - interval '1 day'
                 AND subscription_end <  date_trunc('day', NOW())
                  )
             ORDER BY telegram_id
            """
        )
        return cur.fetchall()
    

def get_pending_payment(user_id: int, deposit_addr: str) -> Optional[int]:
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            SELECT id FROM payments
             WHERE user_id = %s AND deposit_address = %s AND status = 'pending'
            """,
            (user_id, deposit_addr)
        )
        row = cur.fetchone()
        return row[0] if row else None


def create_pending_payment(user_id: int, deposit_addr: str,
                           amount_usdt: float, days_added: int) -> int:
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            INSERT INTO payments (user_id, deposit_address,
                                  amount_usdt, days_added, status)
            VALUES (%s, %s, %s, %s, 'pending')
            RETURNING id
            """,
            (user_id, deposit_addr, amount_usdt, days_added)
        )
        conn.commit()
        return cur.fetchone()[0]
    
def mark_payment_paid(payment_id: int, txid: str):
    with _get_connection() as conn, conn.cursor() as cur:
        cur.execute(
            """
            UPDATE payments
               SET status = 'paid',
                   txhash = %s,
                   paid_at = NOW()
             WHERE id = %s
            """,
            (txid, payment_id)
        )
        conn.commit()


